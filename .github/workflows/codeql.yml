name: "CodeQL (Composer Package)"

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  schedule:
    - cron: '0 */12 * * *'

jobs:
  analyze:
    name: Analyze PHP (Composer)
    runs-on: ubuntu-latest

    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: openssl, mbstring, bcmath, intl, pdo, pdo_mysql, xml, json, tokenizer, fileinfo, dom, curl
          coverage: none

      # Install Composer dependencies
      - name: Install Composer dependencies
        run: |
          if [ -f "composer.json" ]; then
            composer install --no-interaction --no-progress --prefer-dist
          fi

      # Initialize CodeQL
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: [ 'php' ]
          build-mode: manual
          queries: security-extended,security-and-quality

      # Manual build step (CodeQL needs a build step for PHP)
      - name: Manual build
        if: always()
        run: |
          echo "Composer dependencies installed, nothing else to build."

      # Run CodeQL analysis
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:php"
