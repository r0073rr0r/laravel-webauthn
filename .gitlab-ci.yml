stages:
  - sync
  - build
  - test

default:
  image: composer:2
  before_script:
    - apk add --no-cache git jq curl bash sqlite-dev
    - docker-php-ext-install pdo_sqlite

variables:
  COMPOSER_CACHE_DIR: "$CI_PROJECT_DIR/.composer/cache"
  GITLAB_USER: "gitlab-ci-token"
  GITLAB_TOKEN: "$CI_JOB_TOKEN"

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - vendor/
    - .composer/cache/

sync_with_github:
  stage: sync
  variables:
    SYNC_SOURCE_BRANCH: "master"
    SYNC_TARGET_BRANCH: "master"
    SYNC_BRANCH_PREFIX: "sync"
    SYNC_AUTO_APPROVE: "false"
  script:
    - |
      cat <<'BASH' > /tmp/sync_with_github.sh
      #!/usr/bin/env bash
      set -euo pipefail

      SOURCE_BRANCH="${SYNC_SOURCE_BRANCH:-master}"
      TARGET_BRANCH="${SYNC_TARGET_BRANCH:-master}"
      SYNC_BRANCH_PREFIX="${SYNC_BRANCH_PREFIX:-sync}"
      AUTO_APPROVE="${SYNC_AUTO_APPROVE:-false}"

      WORKDIR="github_repo"
      GITLAB_REMOTE_NAME="gitlab"
      GITLAB_REMOTE_URL="https://${GITLAB_USER}:${GITLAB_TOKEN}@git.dbase.in.rs/Majstorov/laravel-webauthn.git"

      if [[ -z "${CI_PIPELINE_ID:-}" ]]; then
        PIPELINE_REF="manual-$(date +%s)"
      else
        PIPELINE_REF="${CI_PIPELINE_ID}"
      fi
      SYNC_BRANCH="${SYNC_BRANCH_PREFIX}/${PIPELINE_REF}"

      git clone https://github.com/r0073rr0r/laravel-webauthn.git "${WORKDIR}"
      cd "${WORKDIR}"

      git remote add "${GITLAB_REMOTE_NAME}" "${GITLAB_REMOTE_URL}"

      git fetch "${GITLAB_REMOTE_NAME}" --prune
      git fetch "${GITLAB_REMOTE_NAME}" "${TARGET_BRANCH}" || true

      git checkout "${SOURCE_BRANCH}"

      git push "${GITLAB_REMOTE_NAME}" --tags --force

      if git rev-parse --verify --quiet "${GITLAB_REMOTE_NAME}/${TARGET_BRANCH}"; then
        if git diff --quiet "${SOURCE_BRANCH}" "${GITLAB_REMOTE_NAME}/${TARGET_BRANCH}"; then
          echo "No changes detected between ${SOURCE_BRANCH} and ${TARGET_BRANCH}. Nothing to sync."
          exit 0
        fi
      else
        echo "Target branch ${TARGET_BRANCH} does not exist on gitlab remote. Proceeding with sync."
      fi

      git push "${GITLAB_REMOTE_NAME}" "HEAD:${SYNC_BRANCH}" --force

      API_BASE="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}"
      MR_TITLE="${SYNC_MR_TITLE:-Sync ${SOURCE_BRANCH} -> ${TARGET_BRANCH}}"
      MR_DESCRIPTION="${SYNC_MR_DESCRIPTION:-Automated sync triggered by pipeline ${CI_PIPELINE_ID:-manual}}"

      EXISTING_MR=$(curl --silent --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
        "${API_BASE}/merge_requests?state=opened&source_branch=${SYNC_BRANCH}&target_branch=${TARGET_BRANCH}")

      if [[ -z "${EXISTING_MR}" || "${EXISTING_MR}" = "[]" ]]; then
        MR_RESPONSE=$(curl --silent --show-error --fail --request POST --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
          --url "${API_BASE}/merge_requests" \
          --data "source_branch=${SYNC_BRANCH}" \
          --data "target_branch=${TARGET_BRANCH}" \
          --data-urlencode "title=${MR_TITLE}" \
          --data-urlencode "description=${MR_DESCRIPTION}" \
          --data "remove_source_branch=true")
      else
        MR_RESPONSE=$(echo "${EXISTING_MR}" | jq '.[0]')
      fi

      MR_IID=$(echo "${MR_RESPONSE}" | jq -r '.iid')
      MR_URL=$(echo "${MR_RESPONSE}" | jq -r '.web_url')
      echo "Merge request available at: ${MR_URL}"

      if [[ "${AUTO_APPROVE}" == "true" && -n "${MR_IID}" && "${MR_IID}" != "null" ]]; then
        if curl --silent --show-error --fail --request POST --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
          --url "${API_BASE}/merge_requests/${MR_IID}/approve"; then
          echo "Merge request auto-approved."
        else
          echo "Auto-approval failed or not permitted. Manual approval required."
        fi
      fi
      BASH
    - chmod +x /tmp/sync_with_github.sh
    - /tmp/sync_with_github.sh
  only:
    - schedules

build:
  stage: build
  script:
    - composer validate --strict
    - composer install --prefer-dist --no-progress

php_tests:
  stage: test
  needs: ["build"]
  script:
    - composer validate --strict
    - composer install --prefer-dist --no-interaction --no-progress
    - vendor/bin/pest -d --colors=always
